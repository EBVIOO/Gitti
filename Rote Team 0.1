// ===== Hardware und Taster =====
const byte buttonPins[4] = {2, 4, 3, 5};
const int  delta[4]      = {1, -1, 1, -1};
const byte axis[4]       = {0, 0, 1, 1};

int value[2] = {0, 0};   // value[0] = X, value[1] = Y

int buttonState[4];      
unsigned long lastDebounce[4]; 
const unsigned long debounceDelay = 50;

// ===== Sensorwerte (Beispiel) =====
float aS1 = 0, aS2 = 0;
float aI1 = 0, aI2 = 0;
float sS1 = 0, sS2 = 0;

// ===== Endschalter =====
const int esl = 52;
const int esr = 53;
bool Autohome = true;

// ===== Seilparameter =====
const float FeldBreite  = 990.0;     
const float FeldHoehe   = 1520.0;    
const float R           = 58.0;      // Trommelradius

float L1 = 0, L2 = 0;
float theta1 = 0, theta2 = 0;

void setup() {
  Serial.begin(115200);

  for (byte i = 0; i < 4; i++) {
    pinMode(buttonPins[i], INPUT_PULLUP);
    buttonState[i] = digitalRead(buttonPins[i]);
    lastDebounce[i] = 0;
  }

  pinMode(esl, INPUT_PULLUP);
  pinMode(esr, INPUT_PULLUP);

  Serial.println("Skycam-Steuerung gestartet");
}

void loop() {
  bool printLine = false;

  // ===== Taster einlesen & entprellen =====
  for (byte i = 0; i < 4; i++) {
    int reading = digitalRead(buttonPins[i]);
    if (reading != buttonState[i]) {
      if (millis() - lastDebounce[i] > debounceDelay) {
        buttonState[i] = reading;
        if (reading == LOW) {
          value[axis[i]] += delta[i];  // X/Y 채ndern
          printLine = true;
        }
      }
      lastDebounce[i] = millis();
    }
  }

  // ===== Beispiel-Sensorwerte =====
  aS1 = 30; aI1 = 25;
  aS2 = 40; aI2 = 35;
  sS1 = aS1 - aI1;
  sS2 = aS2 - aI2;

  // ===== Seill채ngen & Winkel berechnen =====
  berechneSeile(value[0], value[1], L1, L2, theta1, theta2);

  // ===== Ausgabe =====
  if (printLine) {
    Serial.print("X: "); Serial.print(value[0]);
    Serial.print("   Y: "); Serial.print(value[1]);
    Serial.print("   L1="); Serial.print(L1); Serial.print(" mm");
    Serial.print("   L2="); Serial.print(L2); Serial.print(" mm");
    Serial.print("   theta1="); Serial.print(theta1); Serial.print(" rad");
    Serial.print("   theta2="); Serial.println(theta2);  
  }

  // ===== Endschalter pr체fen =====
  calibrate();
}

// ===== Kalibrierung =====
void calibrate() {
  if (!Autohome) return;

  if (digitalRead(esl) == LOW) {
    // Stoppe Rolle links
  }
  if (digitalRead(esr) == LOW) {
    // Stoppe Rolle rechts
  }
}

// ===== Seill채ngenfunktion =====
void berechneSeile(float X, float Y,
                   float &L1, float &L2,
                   float &theta1, float &theta2) {
  // Motorpositionen oben links und rechts
  const float motor1_x = 0.0, motor1_y = FeldHoehe;
  const float motor2_x = FeldBreite, motor2_y = FeldHoehe;

  L1 = sqrt(pow(X - motor1_x, 2) + pow(Y - motor1_y, 2));
  L2 = sqrt(pow(X - motor2_x, 2) + pow(Y - motor2_y, 2));

  theta1 = L1 / R;
  theta2 = L2 / R;
}
